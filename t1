import pandas as pd
from datetime import datetime, timedelta

# Read files
m1 = pd.read_csv('M1.csv')
dashboard = pd.read_csv('mbrDashboard.csv')

# Create frequency lookup dictionary
frequency_dict = dict(zip(dashboard['Application'], dashboard['Frequency']))

# Add frequency column
m1['Frequency'] = m1['Vendor Application'].map(frequency_dict)

# Filter by date
today = datetime.now()
day_of_week = today.weekday()  # 0=Monday, 6=Sunday

if day_of_week == 0:  # Monday
    allowed_dates = [today, today - timedelta(days=1), today - timedelta(days=2), today - timedelta(days=3)]
else:  # Any other day
    allowed_dates = [today, today - timedelta(days=1)]

m1['Process Date'] = pd.to_datetime(m1['Process Date'])
filtered = m1[m1['Process Date'].dt.date.isin([d.date() for d in allowed_dates])].copy()

# Collect results
results = []

# Step 3: Source Count check
source_check = filtered[filtered['Source Count'] < filtered['Current Batch Outbound File Count']]
for idx, row in source_check.iterrows():
    results.append({
        'Feed': row['MEMBER'],
        'Issue type': 'File variance',
        'Application name': row['Vendor Application'],
        'Frequency': row['Frequency'],
        'Date': row['Process Date'],
        'Deviation': row['Source Count'] - row['Current Batch Outbound File Count']
    })

# Step 4: DQ Error check
dq_check = filtered[filtered['Current Batch Data Quality Error Count'] > 100]
for idx, row in dq_check.iterrows():
    results.append({
        'Feed': row['MEMBER'],
        'Issue type': 'DQ Error',
        'Application name': row['Vendor Application'],
        'Frequency': row['Frequency'],
        'Date': row['Process Date'],
        'Deviation': row['Current Batch Data Quality Error Count']
    })

# Step 5: Discrepancy check
disc_check = filtered[filtered['Current Batch Discrepancy'] > 0]
for idx, row in disc_check.iterrows():
    results.append({
        'Feed': row['MEMBER'],
        'Issue type': 'Discrepancy',
        'Application name': row['Vendor Application'],
        'Frequency': row['Frequency'],
        'Date': row['Process Date'],
        'Deviation': row['Current Batch Discrepancy']
    })

# Step 6: File Variance check
var_check = filtered[(filtered['Variance % for Outbound File Count (Current VS Previous Batch)'] < -10) | 
                     (filtered['Variance % for Outbound File Count (Current VS Previous Batch)'] > 10)]
for idx, row in var_check.iterrows():
    results.append({
        'Feed': row['MEMBER'],
        'Issue type': 'File Variance',
        'Application name': row['Vendor Application'],
        'Frequency': row['Frequency'],
        'Date': row['Process Date'],
        'Deviation': row['Variance % for Outbound File Count (Current VS Previous Batch)']
    })

# Save results
output_df = pd.DataFrame(results)
output_df.to_csv('TicketTemp.csv', index=False)
print(f"Done! Found {len(output_df)} issues.")
