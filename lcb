import pandas as pd
from datetime import datetime, timedelta
import win32com.client
from openpyxl import load_workbook
from openpyxl.styles import Border, Side

# Read files
m1 = pd.read_excel('m1.xlsx')
c1 = pd.read_excel('c1.xlsx')
mbr_dashboard = pd.read_excel('mbrDashboard.xlsx')
clms_dashboard = pd.read_excel('clmsDashboard.xlsx')

# Create frequency lookup dictionaries
mbr_freq_dict = dict(zip(mbr_dashboard['Application'], mbr_dashboard['Frequency']))
clms_freq_dict = dict(zip(clms_dashboard.iloc[:, 1], clms_dashboard.iloc[:, 2]))  # B:C columns

# Add frequency column for member
m1['Frequency'] = m1['Vendor Application'].map(mbr_freq_dict).fillna('NA')

# Add frequency column for claims (insert before Month column)
c1.insert(1, 'Frequency', c1['Feed Name'].map(clms_freq_dict).fillna('NA'))

# Filter by date function
def get_allowed_dates():
    today = datetime.now()
    day_of_week = today.weekday()  # 0=Monday, 6=Sunday
    if day_of_week == 0:  # Monday
        allowed_dates = [today, today - timedelta(days=1), today - timedelta(days=2), today - timedelta(days=3)]
    else:  # Any other day
        allowed_dates = [today, today - timedelta(days=1)]
    return [d.date() for d in allowed_dates]

allowed_dates = get_allowed_dates()

# Filter member data
m1['Process Date'] = pd.to_datetime(m1['Process Date'])
filtered_m1 = m1[m1['Process Date'].dt.date.isin(allowed_dates)].copy()

# Filter claims data
c1['Month'] = pd.to_datetime(c1['Month'])
filtered_c1 = c1[c1['Month'].dt.date.isin(allowed_dates)].copy()

# Collect results
results = []

# === MEMBER SIDE PROCESSING ===

# Step 3: Source Count check
source_check = filtered_m1[filtered_m1['Source Count'] < filtered_m1['Current Batch Outbound File Count']]
for idx, row in source_check.iterrows():
    results.append({
        'Feed': 'Member',
        'Issue type': 'File variance',
        'Application name': row['Vendor Application'],
        'Frequency': row['Frequency'],
        'Date': row['Process Date'].strftime('%b %d, %Y').upper(),
        'Deviation': row['Source Count'] - row['Current Batch Outbound File Count']
    })

# Step 4: DQ Error check
dq_check = filtered_m1[filtered_m1['Current Batch Data Quality Error Count'] > 100]
for idx, row in dq_check.iterrows():
    results.append({
        'Feed': 'Member',
        'Issue type': 'DQ Error',
        'Application name': row['Vendor Application'],
        'Frequency': row['Frequency'],
        'Date': row['Process Date'].strftime('%b %d, %Y').upper(),
        'Deviation': row['Current Batch Data Quality Error Count']
    })

# Step 5: Discrepancy check
disc_check = filtered_m1[filtered_m1['Current Batch Discrepancy'] > 0]
for idx, row in disc_check.iterrows():
    results.append({
        'Feed': 'Member',
        'Issue type': 'Discrepancy',
        'Application name': row['Vendor Application'],
        'Frequency': row['Frequency'],
        'Date': row['Process Date'].strftime('%b %d, %Y').upper(),
        'Deviation': row['Current Batch Discrepancy']
    })

# Step 6: File Variance check - FIXED to handle decimal values correctly
var_check = filtered_m1.copy()
var_check['Variance %'] = pd.to_numeric(var_check['Variance % for Outbound File Count (Current VS Previous Batch)'], errors='coerce')
var_check = var_check[(var_check['Variance %'] < -10) | (var_check['Variance %'] > 10)]

for idx, row in var_check.iterrows():
    variance_val = row['Variance %']
    # Handle values like 0.014 or .014
    if abs(variance_val) < 1:
        continue  # Skip values between -1 and 1 (like 0.014)
    results.append({
        'Feed': 'Member',
        'Issue type': 'File Variance',
        'Application name': row['Vendor Application'],
        'Frequency': row['Frequency'],
        'Date': row['Process Date'].strftime('%b %d, %Y').upper(),
        'Deviation': variance_val
    })

# === CLAIMS SIDE PROCESSING ===

# Step 3: DQ Error check for claims
dq_check_c1 = filtered_c1[filtered_c1['BTCH_DQ_VAR_CURR'] > 10]
for idx, row in dq_check_c1.iterrows():
    results.append({
        'Feed': 'Claims',
        'Issue type': 'DQ Error',
        'Application name': row['Feed Name'],
        'Frequency': row['Frequency'],
        'Date': row['Month'].strftime('%b %d, %Y').upper(),
        'Deviation': row['BTCH_DQ_VAR_CURR']
    })

# Step 4: File Variance check for claims - FIXED to handle decimal values correctly
var_check_c1 = filtered_c1.copy()
var_check_c1['File_Var'] = pd.to_numeric(var_check_c1['BTCH_FILE_VAR_CURR'], errors='coerce')
var_check_c1 = var_check_c1[(var_check_c1['File_Var'] < -10) | (var_check_c1['File_Var'] > 10)]

for idx, row in var_check_c1.iterrows():
    file_var_val = row['File_Var']
    # Handle values like 0.014 or .014
    if abs(file_var_val) < 1:
        continue  # Skip values between -1 and 1 (like 0.014)
    results.append({
        'Feed': 'Claims',
        'Issue type': 'File Variance',
        'Application name': row['Feed Name'],
        'Frequency': row['Frequency'],
        'Date': row['Month'].strftime('%b %d, %Y').upper(),
        'Deviation': file_var_val
    })

# Save results to Excel
output_df = pd.DataFrame(results)
output_file = 'TicketTemp.xlsx'

# Write to Excel and add borders
with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
    output_df.to_excel(writer, index=False, sheet_name='Sheet1', startrow=1)

# Add borders
wb = load_workbook(output_file)
ws = wb.active

# Define border style
thin_border = Border(
    left=Side(style='thin'),
    right=Side(style='thin'),
    top=Side(style='thin'),
    bottom=Side(style='thin')
)

# Apply borders to all cells with data
for row in ws.iter_rows(min_row=1, max_row=len(output_df)+2, min_col=1, max_col=len(output_df.columns)):
    for cell in row:
        cell.border = thin_border

wb.save(output_file)

# Create Outlook email with the table
outlook = win32com.client.Dispatch('Outlook.Application')
mail = outlook.CreateItem(0)

# Read the Excel file as HTML table
df_html = output_df.to_html(index=False, border=1)

# Create email body with autofit
html_body = f"""
<html>
<head>
<style>
table {{
    border-collapse: collapse;
    width: auto;
}}
th, td {{
    border: 1px solid black;
    padding: 8px;
    text-align: left;
    white-space: nowrap;
}}
th {{
    background-color: #f2f2f2;
}}
</style>
</head>
<body>
{df_html}
</body>
</html>
"""

mail.HTMLBody = html_body
mail.Subject = ""
mail.To = ""
mail.CC = ""

mail.Display()

print(f"Done! Found {len(output_df)} issues.")
print(f"Results saved to {output_file}")
print("Outlook email template created.")
